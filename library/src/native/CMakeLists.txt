cmake_minimum_required(VERSION 3.22.1)

project(inferkt C CXX)

option(INFER_BUILD_APPLE "Build infer for Apple targets" OFF)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

if (INFER_BUILD_APPLE)
    message("Building for Apple platforms")

    set(CMAKE_OSX_DEPLOYMENT_TARGET 13.0)
    set(CMAKE_XCODE_ATTRIBUTE_ENABLE_BITCODE NO)

    find_library(METAL_LIBRARY Metal REQUIRED)
    find_library(FOUNDATION_LIBRARY Foundation REQUIRED)
    find_library(METALKIT_LIBRARY MetalKit REQUIRED)
    find_library(ACCELERATE_LIBRARY Accelerate REQUIRED)

    set(METAL_SOURCES
            src/ggml-metal.m
            src/ggml-metal.metal
    )
endif ()


set(SOURCES
        src/inferkt.cpp
        src/Inference.cpp
        src/ggml.c
        src/ggml-alloc.c
        src/ggml-backend.cpp
        src/ggml-backend-reg.cpp
        src/ggml-cpu.c
        src/ggml-cpu.cpp
        src/ggml-cpu-aarch64.cpp
        src/ggml-cpu-quants.c
        src/ggml-cpu-traits.cpp
        src/ggml-opt.cpp
        src/ggml-threading.cpp
        src/ggml-quants.c
        src/gguf.cpp
        src/log.cpp
        src/llama-impl.cpp
        src/llama-grammar.cpp
        src/llama-sampling.cpp
        src/llama-vocab.cpp
        src/llama-adapter.cpp
        src/llama-chat.cpp
        src/llama-context.cpp
        src/llama-kv-cache.cpp
        src/llama-arch.cpp
        src/llama-batch.cpp
        src/llama-cparams.cpp
        src/llama-hparams.cpp
        src/llama.cpp
        src/llama-model.cpp
        src/llama-model-loader.cpp
        src/llama-mmap.cpp
        src/llama-vocab.cpp
        src/sampling.cpp
        src/unicode-data.cpp
        src/unicode.cpp
        src/sgemm.cpp
        src/common.cpp
        src/amx/amx.cpp
        src/amx/mmq.cpp
)


if (INFER_BUILD_APPLE)
    if (INFER_IOS_BUILD STREQUAL "iphoneos")
        message("Apple platform ${INFER_IOS_BUILD}")
        list(APPEND SOURCES ${METAL_SOURCES})
        enable_language(ASM)

        add_compile_definitions(GGML_METAL_EMBED_LIBRARY)

        set(METALLIB_COMMON "${CMAKE_CURRENT_SOURCE_DIR}/include/ggml-common.h")
        set(METALLIB_SOURCE "${CMAKE_CURRENT_SOURCE_DIR}/src/ggml-metal.metal")
        set(METALLIB_IMPL "${CMAKE_CURRENT_SOURCE_DIR}/include/ggml-metal-impl.h")

        file(MAKE_DIRECTORY "${CMAKE_BINARY_DIR}/autogenerated")

        # merge ggml-common.h and ggml-metal.metal into a single file
        set(METALLIB_EMBED_ASM "${CMAKE_BINARY_DIR}/autogenerated/ggml-metal-embed.s")
        set(METALLIB_SOURCE_EMBED "${CMAKE_BINARY_DIR}/autogenerated/ggml-metal-embed.metal")
        set(METALLIB_SOURCE_EMBED_TMP "${CMAKE_BINARY_DIR}/autogenerated/ggml-metal-embed.metal.tmp")

        add_custom_command(
                OUTPUT ${METALLIB_EMBED_ASM}
                COMMAND echo "Embedding Metal library"
                COMMAND sed -e '/__embed_ggml-common.h__/r ${METALLIB_COMMON}' -e '/__embed_ggml-common.h__/d' < ${METALLIB_SOURCE} > ${METALLIB_SOURCE_EMBED_TMP}
                COMMAND sed -e '/\#include \"ggml-metal-impl.h\"/r ${METALLIB_IMPL}' -e '/\#include \"ggml-metal-impl.h\"/d' < ${METALLIB_SOURCE_EMBED_TMP} > ${METALLIB_SOURCE_EMBED}
                COMMAND echo ".section __DATA,__ggml_metallib" > ${METALLIB_EMBED_ASM}
                COMMAND echo ".globl _ggml_metallib_start" >> ${METALLIB_EMBED_ASM}
                COMMAND echo "_ggml_metallib_start:" >> ${METALLIB_EMBED_ASM}
                COMMAND echo ".incbin \\\"${METALLIB_SOURCE_EMBED}\\\"" >> ${METALLIB_EMBED_ASM}
                COMMAND echo ".globl _ggml_metallib_end" >> ${METALLIB_EMBED_ASM}
                COMMAND echo "_ggml_metallib_end:" >> ${METALLIB_EMBED_ASM}
                DEPENDS ../ggml-common.h ggml-metal.metal ggml-metal-impl.h
                COMMENT "Generate assembly for embedded Metal library"
        )
    endif ()


endif ()

add_library(inferkt STATIC ${SOURCES})

target_include_directories(inferkt PUBLIC include)

target_compile_features(inferkt PRIVATE cxx_std_17)

if (INFER_BUILD_APPLE)
    set(COMPILE_OPTIONS
            -DGGML_USE_CPU
            -DGGML_USE_ACCELERATE
    )
    if (INFER_IOS_BUILD STREQUAL "iphoneos")
        target_sources(inferkt PRIVATE ${METALLIB_EMBED_ASM})
        list(APPEND COMPILE_OPTIONS
                -DGGML_METAL_EMBED_LIBRARY
                -DGGML_USE_METAL
        )
    endif ()

    target_link_libraries(inferkt PRIVATE
            ${ACCELERATE_LIBRARY}
            ${FOUNDATION_LIBRARY}
            ${METAL_LIBRARY}
            ${METALKIT_LIBRARY}
    )
#    target_compile_options(inferkt PRIVATE
#            -DGGML_USE_CPU
#            -DGGML_USE_ACCELERATE
#            -DGGML_METAL_EMBED_LIBRARY
#            -DGGML_USE_METAL
#            -pthread
#    )
    target_compile_options(
            inferkt
            PRIVATE
            ${COMPILE_OPTIONS}
            -pthread
    )
    target_compile_options(inferkt PRIVATE -O3 -DNDEBUG)
endif ()
